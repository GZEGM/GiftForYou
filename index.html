<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Món quà tặng bạn</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải font chữ từ Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* CSS tùy chỉnh */
      body {
        font-family: "Quicksand", sans-serif;
        background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
        background-size: 400% 400%;
        animation: gradient 15s ease infinite;
      }

      @keyframes gradient {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      #no-button {
        transition: top 0.3s ease-in-out, left 0.3s ease-in-out;
      }
      /* Ẩn thanh cuộn */
      ::-webkit-scrollbar {
        display: none;
      }
      .modal {
        display: none;
        /* Dùng JS để thêm/xóa class 'flex' thay vì 'hidden' để quản lý hiển thị */
      }
    </style>
  </head>
  <body class="h-screen flex items-center justify-center overflow-hidden">
    <!-- Popup nhập tên (hiện khi vào lần đầu) -->
    <div
      id="name-modal"
      class="modal w-full h-full flex items-center justify-center absolute top-0 left-0 bg-black/30 z-20"
    >
      <div
        class="text-center p-6 md:p-8 bg-white/90 backdrop-blur-sm rounded-xl shadow-2xl max-w-sm mx-4"
      >
        <h1 class="text-2xl font-bold text-gray-800 mb-4">
          Chào mừng, vui lòng nhập tên của bạn
        </h1>
        <input
          type="text"
          id="name-input"
          class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Nhập tên..."
        />
        <button
          id="submit-name-button"
          class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition-transform transform hover:scale-105 shadow-lg"
        >
          Xác nhận
        </button>
      </div>
    </div>

    <!-- Popup câu hỏi -->
    <div
      id="question-modal"
      class="modal w-full h-full items-center justify-center absolute top-0 left-0 z-10"
    >
      <div
        id="popup-content"
        class="relative text-center p-6 md:p-8 bg-white/90 backdrop-blur-sm rounded-xl shadow-2xl max-w-sm mx-4"
      >
        <h1 class="text-2xl md:text-4xl font-bold text-gray-800 mb-4">
          Bạn có phải là chó không?
        </h1>
        <div class="flex items-center justify-center space-x-4 min-h-[52px]">
          <button
            id="yes-button"
            class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 shadow-lg"
          >
            YES
          </button>
          <button
            id="no-button"
            class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg"
          >
            NOO
          </button>
        </div>
      </div>
    </div>

    <!-- Popup thành công -->
    <div
      id="success-modal"
      class="modal w-full h-full items-center justify-center absolute top-0 left-0 bg-black/30 z-30"
    >
      <div
        class="text-center p-6 md:p-8 bg-white/90 backdrop-blur-sm rounded-xl shadow-2xl max-w-sm mx-4"
      >
        <h1 class="text-4xl font-bold text-pink-500 mb-2">YAY! Tốt lắm</h1>
        <p class="text-gray-700 mb-6">
          Cảm ơn câu trả lời của bạn, bạn đã được ghi nhận vào danh sách chó
          trong lớp 11A1
        </p>
        <button
          id="show-leaderboard-button"
          class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition-transform transform hover:scale-105 shadow-lg"
        >
          Xem Bảng xếp hạng chó
        </button>
      </div>
    </div>

    <!-- Giao diện danh sách (Bảng xếp hạng & Quản lý User) -->
    <div id="leaderboard" class="modal w-full h-full p-4 md:p-8">
      <div
        class="bg-white/90 backdrop-blur-sm rounded-xl shadow-2xl max-w-4xl mx-auto p-6 h-full flex flex-col"
      >
        <div id="admin-panel" class="hidden text-right mb-4">
          <button
            id="reset-button"
            class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105"
          >
            Reset Trạng Thái
          </button>
        </div>
        <h1
          id="leaderboard-title"
          class="text-3xl md:text-5xl font-bold text-pink-500 mb-6 text-center"
        >
          Bảng Xếp Hạng Chó Của Lớp
        </h1>
        <div class="overflow-y-auto flex-grow">
          <table class="w-full text-left">
            <thead class="sticky top-0 bg-white/90 z-10">
              <tr id="table-header-row">
                <!-- Header sẽ được chèn vào đây bằng JavaScript -->
              </tr>
            </thead>
            <tbody id="leaderboard-body">
              <!-- Dữ liệu sẽ được chèn vào đây bằng JavaScript -->
            </tbody>
          </table>
        </div>
        <p class="text-center text-gray-600 mt-4 text-xs">
          Dữ liệu được cập nhật theo thời gian thực.
        </p>
      </div>
    </div>

    <!-- Tải Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        getDatabase,
        ref,
        set,
        onValue,
        serverTimestamp,
        remove,
        update,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

      // IMPORTANT: REPLACE WITH YOUR FIREBASE CONFIG
      const firebaseConfig = {
        apiKey: "AIzaSyDTKwL2UYOWLlG98eFU2NCLPrOX_JszCHg",
        authDomain: "areyoudog-c753a.firebaseapp.com",
        projectId: "areyoudog-c753a",
        storageBucket: "areyoudog-c753a.firebasestorage.app",
        messagingSenderId: "460484441535",
        appId: "1:460484441535:web:e5b9688a12b06befe6dd0a",
        measurementId: "G-EKKY7QRY8C",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);
      const auth = getAuth(app);

      // Lấy các phần tử HTML
      const nameModal = document.getElementById("name-modal");
      const nameInput = document.getElementById("name-input");
      const submitNameButton = document.getElementById("submit-name-button");
      const questionModal = document.getElementById("question-modal");
      const successModal = document.getElementById("success-modal");
      const showLeaderboardButton = document.getElementById(
        "show-leaderboard-button"
      );
      const popupContent = document.getElementById("popup-content");
      const yesButton = document.getElementById("yes-button");
      const noButton = document.getElementById("no-button");
      const leaderboard = document.getElementById("leaderboard");
      const leaderboardTitle = document.getElementById("leaderboard-title");
      const leaderboardBody = document.getElementById("leaderboard-body");
      const adminPanel = document.getElementById("admin-panel");
      const resetButton = document.getElementById("reset-button");

      let currentUser = null;
      let currentUserData = null;
      let inactivityTimer = null;

      // Hàm quản lý hiển thị các modal
      function showModal(modalElement) {
        document
          .querySelectorAll(".modal")
          .forEach((m) => m.classList.remove("flex"));
        modalElement.classList.add("flex");

        // Xóa bộ đếm thời gian không hoạt động hiện có bất cứ khi nào modal thay đổi
        clearTimeout(inactivityTimer);

        // Nếu modal câu hỏi đang hiển thị, hãy bắt đầu bộ hẹn giờ không hoạt động trong 1 phút
        if (modalElement.id === "question-modal") {
          resetInactivityTimer();
        }
      }

      // 1. Bắt đầu quá trình xác thực
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          checkUserStatus();
          renderViews();
        } else {
          signInAnonymously(auth).catch((error) => {
            console.error("Anonymous sign-in failed:", error);
          });
        }
      });

      // 2. Kiểm tra trạng thái người dùng trong database
      function checkUserStatus() {
        const userRef = ref(database, "users/" + currentUser.uid);
        onValue(userRef, (snapshot) => {
          currentUserData = snapshot.val();
          if (!currentUserData) {
            showModal(nameModal);
          } else if (!currentUserData.isDog) {
            showModal(questionModal);
          } else {
            showModal(successModal);
          }
        });
      }

      // 3. Xử lý logic nút và giao diện
      submitNameButton.addEventListener("click", () => {
        const name = nameInput.value.trim().toUpperCase();
        if (name) {
          const userRef = ref(database, "users/" + currentUser.uid);
          set(userRef, { name: name, uid: currentUser.uid });
        } else {
          alert("Vui lòng nhập tên của bạn!");
        }
      });

      yesButton.addEventListener("click", () => {
        const userRef = ref(database, "users/" + currentUser.uid);
        update(userRef, { isDog: true, timestamp: serverTimestamp() });
      });

      showLeaderboardButton.addEventListener("click", () => {
        showModal(leaderboard);
      });

      // 4. Hiển thị Bảng xếp hạng hoặc Chế độ xem quản trị
      function renderViews() {
        const usersRef = ref(database, "users");
        onValue(usersRef, (snapshot) => {
          const allUsers = snapshot.val() || {};
          const allUsersArray = Object.values(allUsers);
          const isAdmin = currentUserData && currentUserData.name === "ADMIN";

          adminPanel.classList.toggle("hidden", !isAdmin);
          const headerRow = document.getElementById("table-header-row");

          if (isAdmin) {
            // Chế độ xem quản trị: Hiển thị tất cả người dùng và hành động
            leaderboardTitle.textContent = "Quản Lý Người Dùng";
            headerRow.innerHTML = `
                <th class="p-3 border-b-2 border-gray-300">STT</th>
                <th class="p-3 border-b-2 border-gray-300">Tên</th>
                <th class="p-3 border-b-2 border-gray-300">Trạng thái</th>
                <th class="p-3 border-b-2 border-gray-300">Hành động</th>
            `;
            leaderboardBody.innerHTML = "";
            const sortedUsers = allUsersArray.sort((a, b) =>
              (a.name || "").localeCompare(b.name || "")
            );

            if (sortedUsers.length > 0) {
              sortedUsers.forEach((user, index) => {
                const isDog = user.isDog;
                const status = isDog
                  ? `<span class="font-bold text-red-600">Dog</span>`
                  : `<span class="font-bold text-green-600">Chưa dog</span>`;
                const actionButton = isDog
                  ? `<button data-uid="${user.uid}" class="remove-dog-btn bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-bold py-1 px-2 rounded">Xóa</button>`
                  : `<button data-uid="${user.uid}" class="add-dog-btn bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-2 rounded">Thêm dog</button>`;

                const row = document.createElement("tr");
                row.className = "hover:bg-gray-100";
                row.innerHTML = `
                  <td class="p-3 border-b border-gray-200">${index + 1}</td>
                  <td class="p-3 border-b border-gray-200 font-medium">${
                    user.name || "N/A"
                  }</td>
                  <td class="p-3 border-b border-gray-200">${status}</td>
                  <td class="p-3 border-b border-gray-200">${actionButton}</td>
                `;
                leaderboardBody.appendChild(row);
              });
            } else {
              leaderboardBody.innerHTML =
                '<tr><td colspan="4" class="text-center p-4">Không có người dùng nào.</td></tr>';
            }
          } else {
            // Chế độ xem người dùng thông thường: Hiển thị bảng xếp hạng chó
            leaderboardTitle.textContent = "Bảng Xếp Hạng Chó Của Lớp";
            headerRow.innerHTML = `
                <th class="p-3 border-b-2 border-gray-300">STT</th>
                <th class="p-3 border-b-2 border-gray-300">Tên</th>
                <th class="p-3 border-b-2 border-gray-300">Thời gian</th>
            `;
            const dogList = allUsersArray
              .filter((user) => user.isDog)
              .sort((a, b) => a.timestamp - b.timestamp);

            leaderboardBody.innerHTML = "";
            if (dogList.length > 0) {
              dogList.forEach((dog, index) => {
                const date = new Date(dog.timestamp);
                const formattedTime = date.toLocaleString("vi-VN");
                const row = document.createElement("tr");
                row.className = "hover:bg-gray-100";
                row.innerHTML = `
                  <td class="p-3 border-b border-gray-200">${index + 1}</td>
                  <td class="p-3 border-b border-gray-200 font-medium">${
                    dog.name
                  }</td>
                  <td class="p-3 border-b border-gray-200">${formattedTime}</td>
                `;
                leaderboardBody.appendChild(row);
              });
            } else {
              leaderboardBody.innerHTML =
                '<tr><td colspan="3" class="text-center p-4">Chưa có ai trong danh sách.</td></tr>';
            }
          }
        });
      }

      // Thêm trình nghe sự kiện cho các nút quản trị (sử dụng ủy quyền sự kiện)
      leaderboardBody.addEventListener("click", (e) => {
        const target = e.target;
        const uid = target.dataset.uid;
        if (!uid) return;

        const userRef = ref(database, "users/" + uid);
        if (target.classList.contains("add-dog-btn")) {
          update(userRef, { isDog: true, timestamp: serverTimestamp() });
        } else if (target.classList.contains("remove-dog-btn")) {
          update(userRef, { isDog: null, timestamp: null });
        }
      });

      // Logic nút Reset của ADMIN
      resetButton.addEventListener("click", () => {
        const userRef = ref(database, "users/" + currentUser.uid);
        update(userRef, { isDog: null, timestamp: null });
        showModal(questionModal);
      });

      // Logic nút "NOO" chạy trốn
      const moveButton = () => {
        noButton.style.position = "absolute";
        const maxX = popupContent.offsetWidth - noButton.offsetWidth;
        const maxY = popupContent.offsetHeight - noButton.offsetHeight;
        const randomX = Math.floor(Math.random() * maxX);
        const randomY = Math.floor(Math.random() * maxY);
        noButton.style.left = `${randomX}px`;
        noButton.style.top = `${randomY}px`;
      };
      noButton.addEventListener("mouseover", moveButton);
      noButton.addEventListener("click", moveButton);

      // 5. Logic bộ đếm thời gian không hoạt động
      function markAsDog() {
        if (currentUser && currentUserData && !currentUserData.isDog) {
          console.log("User inactive, automatically added to dog list.");
          const userRef = ref(database, "users/" + currentUser.uid);
          update(userRef, { isDog: true, timestamp: serverTimestamp() });
        }
      }

      function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        if (questionModal.classList.contains("flex")) {
          inactivityTimer = setTimeout(markAsDog, 60000); // 60000ms = 1 phút
        }
      }

      // Thêm trình nghe sự kiện để đặt lại bộ hẹn giờ cho bất kỳ hoạt động nào của người dùng
      window.addEventListener("mousemove", resetInactivityTimer);
      window.addEventListener("mousedown", resetInactivityTimer);
      window.addEventListener("keypress", resetInactivityTimer);

      // 6. Tự động thêm vào danh sách khi người dùng thoát/tải lại trang
      window.addEventListener("beforeunload", (event) => {
        if (currentUser && currentUserData && !currentUserData.isDog) {
          const userRef = ref(database, "users/" + currentUser.uid);
          update(userRef, { isDog: true, timestamp: serverTimestamp() });
        }
      });
    </script>
  </body>
</html>
